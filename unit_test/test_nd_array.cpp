
#include "core/utils.hpp"
#include "ic/nd_array.hpp"
#include <gtest/gtest.h>

using namespace block2;

class TestNDArray : public ::testing::Test {
  protected:
    void SetUp() override {}
    void TearDown() override {}
    static void check_perm(const vector<MKL_INT> &shape,
                           const vector<int> &perm) {
        NDArray x = NDArray::random(shape);
        NDArray y = x.transpose(perm);
        NDArray z(y.shape);
        NDArray::transpose(y, z);
        EXPECT_EQ(y.ndim(), z.ndim());
        EXPECT_EQ(y.size(), z.size());
        size_t sz = z.size();
        for (size_t i = 0; i < sz; i++) {
            vector<MKL_INT> yi = x.decompose_linear_index(i), zi;
            for (auto &p : perm)
                zi.push_back(yi[p]);
            EXPECT_EQ(x.data[i], z[zi]);
        }
    }
    static void check_tensordot(const vector<MKL_INT> &ash,
                                const vector<MKL_INT> &bsh,
                                const vector<int> &aidx,
                                const vector<int> &bidx,
                                const vector<int> &br_aidx = {},
                                const vector<int> &br_bidx = {}) {
        NDArray a = NDArray::random(ash);
        NDArray b = NDArray::random(bsh);
        size_t ctr_size = 1, br_size = 1;
        assert(aidx.size() == bidx.size());
        assert(br_aidx.size() == br_bidx.size());
        for (int i = 0; i < (int)aidx.size(); i++) {
            assert(a.shape[aidx[i]] == b.shape[bidx[i]]);
            ctr_size *= a.shape[aidx[i]];
        }
        for (int i = 0; i < (int)br_aidx.size(); i++) {
            assert(a.shape[br_aidx[i]] == b.shape[br_bidx[i]]);
            br_size *= a.shape[br_aidx[i]];
        }
        size_t a_out_size = a.size() / ctr_size / br_size;
        size_t b_out_size = b.size() / ctr_size / br_size;
        vector<MKL_INT> csh;
        csh.reserve(a.ndim() + b.ndim() - aidx.size() - bidx.size() -
                    br_aidx.size());
        vector<int> aidxs(a.ndim(), 0), bidxs(b.ndim(), 0);
        for (auto &x : aidx)
            aidxs[x] = -1;
        for (auto &x : bidx)
            bidxs[x] = -1;
        for (auto &x : br_aidx)
            aidxs[x] = -2;
        for (auto &x : br_bidx)
            bidxs[x] = -2;
        int aout_dim = a.ndim() - (int)aidx.size() - (int)br_aidx.size();
        int bout_dim = b.ndim() - (int)bidx.size() - (int)br_aidx.size();
        int br_dim = (int)br_aidx.size();
        vector<int> br_order(br_dim);
        for (int i = 0; i < br_dim; i++)
            br_order[i] = i;
        sort(br_order.begin(), br_order.begin() + br_dim,
             [&br_aidx](int a, int b) { return br_aidx[a] < br_aidx[b]; });
        for (int i = 0; i < a.ndim(); i++)
            if (aidxs[i] == -2)
                csh.push_back(a.shape[i]);
        for (int i = 0; i < a.ndim(); i++)
            if (aidxs[i] == 0)
                csh.push_back(a.shape[i]);
        for (int i = 0; i < b.ndim(); i++)
            if (bidxs[i] == 0)
                csh.push_back(b.shape[i]);
        NDArray c(csh);
        NDArray::tensordot(a, b, c, aidx, bidx, br_aidx, br_bidx);
        vector<int> cidxs(c.ndim(), 0);
        for (size_t ix = 0, ixx; ix < br_size; ix++) {
            for (size_t ia = 0, iax; ia < a_out_size; ia++) {
                for (auto &x : aidx)
                    aidxs[x] = -1;
                for (auto &x : br_aidx)
                    aidxs[x] = -1;
                iax = ia;
                for (int k = a.ndim() - 1, kc = aout_dim - 1 + br_dim; k >= 0;
                     k--)
                    if (aidxs[k] != -1)
                        aidxs[k] = cidxs[kc--] = iax % a.shape[k],
                        iax /= a.shape[k];
                for (size_t ib = 0, ibx; ib < b_out_size; ib++) {
                    for (auto &x : bidx)
                        bidxs[x] = -1;
                    for (auto &x : br_bidx)
                        bidxs[x] = -1;
                    ibx = ib;
                    for (int k = b.ndim() - 1, kc = c.ndim() - 1; k >= 0; k--)
                        if (bidxs[k] != -1)
                            bidxs[k] = cidxs[kc--] = ibx % b.shape[k],
                            ibx /= b.shape[k];
                    double v = 0;
                    ixx = ix;
                    for (int i = br_dim - 1; i >= 0; i--) {
                        const int xa = br_aidx[br_order[i]];
                        const int xb = br_bidx[br_order[i]];
                        aidxs[xa] = ixx % a.shape[xa];
                        bidxs[xb] = ixx % b.shape[xb];
                        cidxs[i] = ixx % c.shape[i];
                        ixx /= a.shape[xa];
                    }
                    for (size_t ic = 0, icx; ic < ctr_size; ic++) {
                        icx = ic;
                        for (auto &x : aidx)
                            aidxs[x] = icx % a.shape[x], icx /= a.shape[x];
                        icx = ic;
                        for (auto &x : bidx)
                            bidxs[x] = icx % b.shape[x], icx /= b.shape[x];
                        v += a[aidxs] * b[bidxs];
                    }
                    EXPECT_LE(abs(v - c[cidxs]), 1E-10);
                }
            }
        }
    }
    static void check_sum(const vector<MKL_INT> &shape,
                          const vector<int> &idx) {
        NDArray x = NDArray::random(shape);
        vector<int> idxs(x.ndim(), 0), perm;
        for (auto &x : idx)
            idxs[x] = -1;
        for (int i = 0; i < x.ndim(); i++)
            if (idxs[i] != -1)
                perm.push_back(i);
        int idx_at = (int)perm.size();
        for (auto &x : idx)
            perm.push_back(x);
        NDArray y = x.transpose(perm);
        if (!y.is_c_order()) {
            NDArray w(y.shape);
            NDArray::transpose(y, w);
            y = w;
        }
        NDArray z = y.sum(idx_at);
        EXPECT_EQ(idx_at, z.ndim());
        size_t sz = z.size(), ssz = x.size() / z.size();
        for (size_t i = 0; i < sz; i++) {
            vector<MKL_INT> zi = z.decompose_linear_index(i), yi, xi(x.ndim());
            for (int k = 0; k < idx_at; k++)
                xi[perm[k]] = zi[k];
            double v = 0;
            for (size_t j = 0; j < ssz; j++) {
                yi = y.decompose_linear_index(j);
                for (int k = idx_at; k < x.ndim(); k++)
                    xi[perm[k]] = yi[k];
                v += x[xi];
            }
            EXPECT_EQ(v, z[zi]);
        }
    }
};

TEST_F(TestNDArray, TestTranspose) {
    Random::rand_seed(1234);

    check_perm({264, 264}, {1, 0});
    check_perm({34, 216}, {1, 0});
    check_perm({216, 348}, {1, 0});

    check_perm({68, 84, 84}, {0, 2, 1});
    check_perm({14, 64, 84}, {0, 2, 1});
    check_perm({68, 64, 37}, {0, 2, 1});
    check_perm({84, 84, 55}, {1, 0, 2});
    check_perm({320, 84, 59}, {1, 0, 2});
    check_perm({84, 59, 320}, {2, 1, 0});

    check_perm({80, 6, 75, 6}, {0, 3, 2, 1});
    check_perm({8, 12, 96, 7}, {2, 1, 3, 0});
    check_perm({96, 75, 6, 7}, {2, 0, 3, 1});
    check_perm({96, 8, 12, 7}, {1, 0, 3, 2});

    check_perm({32, 8, 7, 4, 7}, {0, 4, 2, 1, 3});
    check_perm({52, 4, 28, 4, 8}, {3, 2, 1, 4, 0});

    check_perm({16, 2, 15, 4, 10, 15}, {0, 3, 2, 5, 4, 1});
    check_perm({12, 15, 5, 10, 4, 9}, {2, 0, 4, 1, 5, 3});
}

TEST_F(TestNDArray, TestSum) {
    Random::rand_seed(1234);

    check_sum({264, 264}, {0});
    check_sum({348, 16}, {1});
    check_sum({216, 308}, {1, 0});

    check_sum({68, 84, 8}, {2});
    check_sum({144, 64, 8}, {1});
    check_sum({68, 64, 37}, {2, 1});
    check_sum({84, 84, 55}, {0, 2});
    check_sum({320, 84, 59}, {1, 0});
    check_sum({84, 59, 20}, {0, 1});

    check_sum({8, 6, 75, 6}, {3, 2});
    check_sum({8, 12, 96, 75}, {1});
    check_sum({96, 75, 6, 75}, {0, 3, 1});
    check_sum({96, 8, 12, 75}, {1, 0, 3, 2});

    check_sum({32, 8, 7, 4, 7}, {4, 2, 1});
    check_sum({52, 4, 28, 4, 8}, {3, 0});

    check_sum({16, 2, 15, 4, 14, 15}, {0, 3, 2, 5});
    check_sum({12, 15, 5, 10, 4, 9}, {2, 0, 4});
}

TEST_F(TestNDArray, TestTensordot) {
    Random::rand_seed(1234);

    check_tensordot({4, 25}, {34, 4}, {}, {}, {0}, {1});
    check_tensordot({25, 34, 3}, {3, 34}, {1}, {1}, {2}, {0});
    check_tensordot({23, 4, 2}, {2, 33, 4, 23}, {0}, {3}, {2, 1}, {0, 2});

    check_tensordot({4, 25, 5, 34}, {4, 34, 5, 41}, {3}, {1}, {0, 2}, {0, 2});
    check_tensordot({25, 6, 34}, {6, 25, 9}, {0}, {1}, {1}, {0});
    check_tensordot({3, 2, 9, 34}, {2, 3, 25, 9}, {2}, {3}, {1, 0}, {0, 1});
    check_tensordot({9, 4, 1, 77}, {2, 1, 4, 77}, {3}, {3}, {1, 2}, {2, 1});
    check_tensordot({3, 23, 41}, {3, 5, 3}, {}, {}, {0}, {0});
    check_tensordot({23, 12, 9}, {23, 12, 9}, {1, 0}, {1, 0}, {2}, {2});
    check_tensordot({32, 6, 27}, {27, 32, 6}, {2, 0}, {0, 1}, {1}, {2});

    check_tensordot({4, 34, 3}, {34, 4, 2, 3}, {0, 1}, {1, 0}, {2}, {3});
    check_tensordot({1, 1, 3, 2, 23}, {1, 2, 1, 3, 42, 23}, {4}, {5}, {3, 2, 1},
                    {1, 3, 2});
    check_tensordot({4, 27, 2, 3, 4}, {11, 2, 27, 3, 4, 4}, {0, 1}, {4, 2},
                    {2, 4, 3}, {1, 5, 3});
    check_tensordot({4, 27, 9, 2, 5}, {2, 11, 5, 2}, {}, {}, {3, 4}, {0, 2});
    check_tensordot({4, 27, 9, 6}, {11, 6, 27}, {1}, {2}, {3}, {1});
    check_tensordot({4, 27, 9, 5, 3}, {4, 3, 5, 9}, {2, 0}, {3, 0}, {4, 3},
                    {1, 2});

    check_tensordot({8, 4, 7, 3, 4, 2}, {3, 4, 2, 9, 8, 4}, {4, 0}, {1, 4},
                    {3, 5, 1}, {0, 2, 5});
    check_tensordot({8, 2, 2, 3, 7, 3, 4}, {3, 2, 3, 4, 8, 2, 7}, {6, 0, 4},
                    {3, 4, 6}, {3, 5, 1, 2}, {0, 2, 1, 5});

    check_tensordot({8, 7, 5, 66}, {4, 8, 7, 66, 5, 11}, {1, 3}, {2, 3}, {2},
                    {4});

    check_tensordot({2, 3, 3, 8, 7, 4, 2, 3}, {2, 8, 3, 3, 2, 4, 2, 6},
                    {6, 3, 5}, {0, 1, 5}, {0, 2, 1}, {4, 3, 2});
    check_tensordot({4, 5, 3, 7, 4, 3, 9}, {4, 3, 3, 7, 8, 5, 4}, {3, 0, 2, 1},
                    {3, 6, 2, 5}, {5, 4}, {1, 0});

    check_tensordot({25}, {34}, {}, {});
    check_tensordot({25, 34}, {34}, {1}, {0});
    check_tensordot({23}, {33, 23}, {0}, {1});

    check_tensordot({25, 34}, {34, 41}, {1}, {0});
    check_tensordot({25, 34}, {25, 9}, {0}, {0});
    check_tensordot({9, 34}, {25, 9}, {0}, {1});
    check_tensordot({9, 77}, {2, 77}, {1}, {1});
    check_tensordot({23, 41}, {5, 3}, {}, {});
    check_tensordot({23, 12}, {23, 12}, {1, 0}, {1, 0});
    check_tensordot({32, 27}, {27, 32}, {1, 0}, {0, 1});

    check_tensordot({4, 34}, {34, 4, 2}, {0, 1}, {1, 0});
    check_tensordot({1, 23}, {1, 42, 23}, {1}, {2});
    check_tensordot({4, 27}, {11, 27, 4}, {0, 1}, {2, 1});
    check_tensordot({4, 27, 9}, {11, 2}, {}, {});
    check_tensordot({4, 27, 9}, {11, 27}, {1}, {1});
    check_tensordot({4, 27, 9}, {4, 9}, {2, 0}, {1, 0});

    check_tensordot({8, 7, 4}, {4, 9, 8}, {2, 0}, {0, 2});
    check_tensordot({8, 7, 4}, {4, 8, 7}, {2, 0, 1}, {0, 1, 2});

    check_tensordot({8, 7, 66}, {4, 8, 7, 66, 11}, {1, 2}, {2, 3});

    check_tensordot({8, 7, 4, 2, 3}, {2, 8, 4, 2, 6}, {3, 0, 2}, {0, 1, 2});
    check_tensordot({4, 5, 3, 7, 9}, {3, 7, 8, 5, 4}, {3, 0, 2, 1},
                    {1, 4, 0, 3});
}

TEST_F(TestNDArray, TestEinsum) {

    NDArray ref, a, b, c, d;
    double diff;

    a = NDArray(
        {7, 1, 3, 4},
        vector<double>{0.49766366630595, 0.81783844288953, 0.61211189358442,
                       0.77135991905475, 0.86066977348644, 0.15063696570522,
                       0.19851876010105, 0.81516293408393, 0.15881535340057,
                       0.11613783027882, 0.01290753305839, 0.48683344491315,
                       0.33101542682468, 0.80263957374559, 0.09825193844043,
                       0.05599344953922, 0.44266265526020, 0.02214390901238,
                       0.29072854825594, 0.24639444143573, 0.73828676607574,
                       0.88922613337994, 0.98713930325475, 0.11744338329156,
                       0.39378235045195, 0.45272980901678, 0.53814783212664,
                       0.79062210437579, 0.46583634319642, 0.43533225277627,
                       0.56947865613483, 0.96925900048487, 0.04055615323646,
                       0.54811957202474, 0.46257660088694, 0.37647223419151,
                       0.32791208457639, 0.81352893261352, 0.64655232346667,
                       0.04742648194295, 0.99495757000051, 0.68923564445793,
                       0.92954593432307, 0.91811655291237, 0.97530172313438,
                       0.39700197138202, 0.26262609312388, 0.43015136326697,
                       0.76453077102305, 0.59973081515705, 0.08094695376044,
                       0.70454447055403, 0.16401332210888, 0.03234934574151,
                       0.32815035959180, 0.47385999930839, 0.06808471930924,
                       0.38271069642903, 0.11855413950020, 0.89632852184399,
                       0.76430853043805, 0.37540493594131, 0.02581419015259,
                       0.90653093629416, 0.78641778239569, 0.61931522983449,
                       0.21158894022267, 0.29230400616815, 0.66154467713180,
                       0.88626097308457, 0.67117646144203, 0.32968078963163,
                       0.20736179977461, 0.01163207485972, 0.07154342001984,
                       0.73005590818356, 0.97983959652874, 0.69001621718888,
                       0.99057483417127, 0.69053431910012, 0.94812322278435,
                       0.58364464449979, 0.53155326212714, 0.16865733792673});

    b = NDArray(
        {2, 4, 5, 7},
        vector<double>{0.15880774443643, 0.93796531393887, 0.71826455573227,
                       0.47654264649167, 0.88365335963520, 0.40420231605841,
                       0.17146804978898, 0.13183202211941, 0.41190816055243,
                       0.02485604443388, 0.56356079235681, 0.78187791293081,
                       0.26705996192453, 0.21425496596359, 0.17755704095054,
                       0.42926568227574, 0.97211311891841, 0.04653157706096,
                       0.91735446657913, 0.15893008083984, 0.94338268529760,
                       0.76316152516453, 0.05387827405465, 0.25408163633987,
                       0.92797262806307, 0.83831150805364, 0.15692453536338,
                       0.69077595118285, 0.36694643726987, 0.93747272084476,
                       0.61336482243591, 0.69934982323381, 0.50294625697378,
                       0.71111089693908, 0.13438584723086, 0.82893194088399,
                       0.74284586886099, 0.45703374149746, 0.07910335268340,
                       0.37304659737254, 0.93363636296502, 0.41872481027418,
                       0.23421156856585, 0.57248483217730, 0.57211088553847,
                       0.41689297953970, 0.62588308642693, 0.22036227481218,
                       0.62205912984300, 0.47767162003719, 0.97434207987345,
                       0.77298465770064, 0.02713854238266, 0.22102234772860,
                       0.12032831537480, 0.17527398945957, 0.42946155951576,
                       0.65776917894852, 0.56589859188004, 0.56903498469780,
                       0.65419601231925, 0.36855768303690, 0.95238467555689,
                       0.19677047830597, 0.84993003251787, 0.96045828617016,
                       0.38111827102827, 0.33093620479754, 0.26092345878846,
                       0.66549108249794, 0.18179543241304, 0.37679993961530,
                       0.01425856113471, 0.33913530337494, 0.40135140429684,
                       0.46757366754309, 0.65210549933877, 0.99719214246103,
                       0.51746228336175, 0.40361155171179, 0.05844676447882,
                       0.04519571359705, 0.62708044181231, 0.00806841171609,
                       0.41788025407366, 0.00634233489941, 0.42420633546855,
                       0.36278279041082, 0.61878758862687, 0.41900078250827,
                       0.01371138361647, 0.41334959439350, 0.21985716031995,
                       0.52993667167649, 0.77967003052652, 0.52172731927162,
                       0.50547663602577, 0.06520625145493, 0.40824889713911,
                       0.70322201766821, 0.92442993853332, 0.55011141510472,
                       0.33244957783335, 0.64318559754890, 0.95203233498045,
                       0.21441908910508, 0.90481733033454, 0.52859398981701,
                       0.75754870222217, 0.52235971967156, 0.59450565979980,
                       0.37082038618849, 0.08223248077657, 0.52991990607770,
                       0.75915807876791, 0.01777810020036, 0.03533421805572,
                       0.94394710773631, 0.40556918355349, 0.44790189525357,
                       0.78263590874262, 0.57419279606936, 0.87642587908569,
                       0.36038531093846, 0.42729407252792, 0.83383315855986,
                       0.11213940849610, 0.86878024594878, 0.79134595289577,
                       0.49167366201548, 0.39582694569377, 0.03559736566872,
                       0.17168925340444, 0.18904467332529, 0.10286923485817,
                       0.90904121100514, 0.58232868075683, 0.89883123804173,
                       0.43500218398913, 0.07836778156303, 0.22470751762198,
                       0.69762604255931, 0.49999016415277, 0.50427863006779,
                       0.74624744924328, 0.87717688791909, 0.22107584683059,
                       0.28737948919899, 0.99326441571016, 0.86158526826932,
                       0.10884519931311, 0.36580838642477, 0.56548686101379,
                       0.40568058817361, 0.03227048085563, 0.16937394729520,
                       0.43069256120412, 0.78043438984127, 0.42717173070223,
                       0.78993092142004, 0.38612596483586, 0.97910036968467,
                       0.21940539382826, 0.09285527389062, 0.97542666970349,
                       0.28834408425145, 0.37058617787118, 0.99888253276208,
                       0.52192259918975, 0.82299625781322, 0.84931438452693,
                       0.68579636110432, 0.03433940680308, 0.05350065086908,
                       0.08452257295427, 0.81635422482054, 0.91442704448232,
                       0.70980936863604, 0.03718316840017, 0.53067952436114,
                       0.36975316420581, 0.66109922684911, 0.14112446892363,
                       0.86066664114416, 0.45112462943813, 0.97978134049679,
                       0.54205321085951, 0.68360806804107, 0.93754947893198,
                       0.54670336121485, 0.16520389858094, 0.48875867245958,
                       0.70090497679810, 0.42004453360172, 0.17756138301365,
                       0.78183722505581, 0.54316449608698, 0.78156606158572,
                       0.59354457621588, 0.10917367021853, 0.01069768671100,
                       0.01322471083002, 0.45195241665209, 0.98834519570701,
                       0.64423490197016, 0.32160722494070, 0.16353740502537,
                       0.21544533565168, 0.89000038357954, 0.92885554907464,
                       0.52994077178671, 0.91240926793078, 0.15618660128831,
                       0.87561638951818, 0.34956839159782, 0.85655870081808,
                       0.80311836099389, 0.35297494101961, 0.83292410486187,
                       0.35737479607906, 0.63721697300841, 0.21972157414948,
                       0.28365922117739, 0.01199709100206, 0.20102637493755,
                       0.76445128265628, 0.22728855505446, 0.38749153939446,
                       0.49016629533626, 0.52521129026022, 0.51334927421099,
                       0.75777342945422, 0.35511885665746, 0.51460647670860,
                       0.33840971576989, 0.85725544431186, 0.57467626287895,
                       0.41140449573238, 0.32613068718786, 0.60433543974934,
                       0.47201608142099, 0.98286988238158, 0.92706395447794,
                       0.34516176025969, 0.37327842997822, 0.60674266332271,
                       0.39425211983080, 0.47023671598080, 0.51031779414159,
                       0.27195836370803, 0.14531194304781, 0.26371426049792,
                       0.41123287542673, 0.32718296917181, 0.63716155474152,
                       0.19553722058636, 0.44477233289584, 0.31069714247374,
                       0.56526455464291, 0.95279584825779, 0.99823853116543,
                       0.71300956386133, 0.45617712689745, 0.39824479303209,
                       0.23956812061932, 0.77379412160689, 0.42542122344608,
                       0.98569388337754, 0.86180394178617, 0.71057438930608,
                       0.07704796060503, 0.23163648895127, 0.42776319337189,
                       0.20753727945676, 0.75349503311562, 0.45792917608858,
                       0.52524880730150, 0.28442190154757, 0.68496863622290,
                       0.62542190752844});

    ref = NDArray(
        {3, 5, 1, 2},
        vector<double>{6.28725626313192, 6.78378567125400, 5.76489395388762,
                       6.82736261048587, 6.28745629596652, 6.30674403511806,
                       6.19061375391323, 5.85592828047926, 7.07834045984829,
                       6.38064454358537, 6.89399162873458, 7.68021798796523,
                       4.89715197735687, 7.25563939146718, 6.45265097644679,
                       8.05230818165392, 7.64016411440259, 8.17288735754047,
                       8.56042283930413, 7.85464298265267, 6.59534243175677,
                       7.45929533462693, 5.08524418471264, 7.02343589768663,
                       5.31453271735593, 6.61734281566143, 6.36546097353740,
                       6.45459780126276, 8.19994587714135, 6.64520923741800});

    diff = (NDArray::einsum("abcd,fdea->cebf", {a, b}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    ref = NDArray(
        {7, 1, 3, 2},
        vector<double>{0.81783844288953, 0.77135991905475, 0.15063696570522,
                       0.81516293408393, 0.11613783027882, 0.48683344491315,
                       0.80263957374559, 0.05599344953922, 0.02214390901238,
                       0.24639444143573, 0.88922613337994, 0.11744338329156,
                       0.45272980901678, 0.79062210437579, 0.43533225277627,
                       0.96925900048487, 0.54811957202474, 0.37647223419151,
                       0.81352893261352, 0.04742648194295, 0.68923564445793,
                       0.91811655291237, 0.39700197138202, 0.43015136326697,
                       0.59973081515705, 0.70454447055403, 0.03234934574151,
                       0.47385999930839, 0.38271069642903, 0.89632852184399,
                       0.37540493594131, 0.90653093629416, 0.61931522983449,
                       0.29230400616815, 0.88626097308457, 0.32968078963163,
                       0.01163207485972, 0.73005590818356, 0.69001621718888,
                       0.69053431910012, 0.58364464449979, 0.16865733792673});

    diff = (a.slice(NDArraySlice::parse(":, :, :, 1::2")) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    ref = NDArray(
        {2, 2, 2, 7},
        vector<double>{0.23421156856585, 0.57248483217730, 0.57211088553847,
                       0.41689297953970, 0.62588308642693, 0.22036227481218,
                       0.62205912984300, 0.47767162003719, 0.97434207987345,
                       0.77298465770064, 0.02713854238266, 0.22102234772860,
                       0.12032831537480, 0.17527398945957, 0.08223248077657,
                       0.52991990607770, 0.75915807876791, 0.01777810020036,
                       0.03533421805572, 0.94394710773631, 0.40556918355349,
                       0.44790189525357, 0.78263590874262, 0.57419279606936,
                       0.87642587908569, 0.36038531093846, 0.42729407252792,
                       0.83383315855986, 0.14112446892363, 0.86066664114416,
                       0.45112462943813, 0.97978134049679, 0.54205321085951,
                       0.68360806804107, 0.93754947893198, 0.54670336121485,
                       0.16520389858094, 0.48875867245958, 0.70090497679810,
                       0.42004453360172, 0.17756138301365, 0.78183722505581,
                       0.41123287542673, 0.32718296917181, 0.63716155474152,
                       0.19553722058636, 0.44477233289584, 0.31069714247374,
                       0.56526455464291, 0.95279584825779, 0.99823853116543,
                       0.71300956386133, 0.45617712689745, 0.39824479303209,
                       0.23956812061932, 0.77379412160689});

    diff = (b.slice(NDArraySlice::parse(":, 1::2, 1:3, :")) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    ref = NDArray(
        {3, 2, 1, 2},
        vector<double>{3.58538781220862, 4.25641115942948, 3.85935843233333,
                       4.13773116480584, 2.69277309502878, 3.90468551387043,
                       3.44196889885542, 4.37053749064082, 2.62024675602253,
                       3.93750361762281, 3.15753471638962, 3.14317992996825});

    diff = (NDArray::einsum("abcd,fdea->cebf",
                            {a.slice(NDArraySlice::parse(":, :, :, 1::2")),
                             b.slice(NDArraySlice::parse(":, 1::2, 1:3, :"))}) -
            ref)
               .norm();
    EXPECT_LT(diff, 1E-12);

    ref = NDArray(
        {3, 5, 1, 2},
        vector<double>{3.81309201414010, 3.68542863964669, 3.20135917983862,
                       4.20300109798650, 3.46084219795611, 3.87914342413353,
                       4.29188917266903, 3.15039363737014, 5.10120721573465,
                       3.64416450455280, 4.95372326921191, 4.65447603882482,
                       3.65043606072955, 4.24848623610894, 4.09609628833214,
                       4.32017500322920, 4.09418399359958, 3.50820264068138,
                       5.54204684793479, 4.49856469915916, 3.03660096874756,
                       3.59743341546683, 2.61940271809982, 3.71970802160870,
                       2.12558427584233, 3.81686970613879, 3.74702912852862,
                       2.80496935094971, 3.97721685229758, 3.53111271283813});

    diff = (NDArray::einsum("abcd,fdea->cebf",
                            {a.slice(NDArraySlice::parse(":4")),
                             b.slice(NDArraySlice::parse(":, :, :, 2:6"))}) -
            ref)
               .norm();
    EXPECT_LT(diff, 1E-12);

    ref = NDArray(
        {2, 5, 1, 2},
        vector<double>{6.89399162873458, 7.68021798796523, 4.89715197735687,
                       7.25563939146718, 6.45265097644679, 8.05230818165392,
                       7.64016411440259, 8.17288735754047, 8.56042283930413,
                       7.85464298265267, 6.59534243175677, 7.45929533462693,
                       5.08524418471264, 7.02343589768663, 5.31453271735593,
                       6.61734281566143, 6.36546097353740, 6.45459780126276,
                       8.19994587714135, 6.64520923741800});

    diff = (NDArray::einsum("abcd,fdea->cebf",
                            {a.slice(NDArraySlice::parse(":, :, 1:3, :")), b}) -
            ref)
               .norm();
    EXPECT_LT(diff, 1E-12);

    ref = NDArray({2, 2, 1, 2},
                  vector<double>{6.89399162873458, 7.68021798796523,
                                 4.89715197735687, 7.25563939146718,
                                 6.59534243175677, 7.45929533462693,
                                 5.08524418471264, 7.02343589768663});

    diff = (NDArray::einsum("abcd,fdea->cebf",
                            {a.slice(NDArraySlice::parse(":, :, 1:3")),
                             b.slice(NDArraySlice::parse(":, :, :2, :"))}) -
            ref)
               .norm();
    EXPECT_LT(diff, 1E-12);

    ref = NDArray({1, 2, 1, 2},
                  vector<double>{3.80922450427532, 4.40734974251746,
                                 3.43118053030252, 3.97509988777349});

    diff = (NDArray::einsum("abcd,fdea->cebf",
                            {a.slice(NDArraySlice::parse("2:6, :, :1")),
                             b.slice(NDArraySlice::parse(":, :, 1:3, 2:6"))}) -
            ref)
               .norm();
    EXPECT_LT(diff, 1E-12);

    ref = NDArray(
        {3, 2, 1, 2},
        vector<double>{5.76489395388762, 6.82736261048587, 6.28745629596652,
                       6.30674403511806, 4.89715197735687, 7.25563939146718,
                       6.45265097644679, 8.05230818165392, 5.08524418471264,
                       7.02343589768663, 5.31453271735593, 6.61734281566143});

    diff = (NDArray::einsum("abcd,fdea->cebf",
                            {a, b.slice(NDArraySlice::parse(":, :, 1:3, :"))}) -
            ref)
               .norm();
    EXPECT_LT(diff, 1E-12);

    c = NDArray({2, 2}, vector<double>{0.36486929791704, 0.03325110643004,
                                       0.30385740382771, 0.17769493602378});
    d = NDArray({2, 2}, vector<double>{0.24427221430989, 0.16409214011331,
                                       0.33415912646295, 0.09437292942488});

    ref = NDArray({}, vector<double>{0.16686879535437});

    diff = (NDArray::einsum("cd,dc->", {c, d}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    c = NDArray({2, 2, 3}, vector<double>{0.81212848728085, 0.42803238668328,
                                          0.34685512619240, 0.37922246200936,
                                          0.80940640364546, 0.68079474958236,
                                          0.02858324432431, 0.37557797867173,
                                          0.91972592856906, 0.17191324715194,
                                          0.45001633782056, 0.17998223466648});
    d = NDArray({3, 2, 2}, vector<double>{0.30851712712799, 0.98898166290538,
                                          0.92284353102984, 0.13187791190893,
                                          0.98859552500864, 0.06957757882007,
                                          0.05743923550343, 0.86788253047940,
                                          0.86384207918593, 0.75982356384792,
                                          0.69535960627993, 0.48451152207470});

    ref = NDArray({}, vector<double>{3.09685224140467});

    diff = (NDArray::einsum("acd,dca->", {c, d}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    c = NDArray(
        {2, 8, 3, 6},
        vector<double>{0.56067189468847, 0.99110784798454, 0.08316526567237,
                       0.76519280353192, 0.31064628872904, 0.77118149067370,
                       0.26657616184528, 0.36545818887786, 0.05168241788179,
                       0.01191448535090, 0.94236298239301, 0.94955497517252,
                       0.96673268208193, 0.43919940495379, 0.16558615637446,
                       0.98572533271779, 0.77168361817156, 0.84186144400588,
                       0.30150025879527, 0.95039965630007, 0.78334247179763,
                       0.37160831078539, 0.26094864586152, 0.43986414425010,
                       0.43577524728490, 0.59148367443352, 0.73159735858314,
                       0.06025293181592, 0.36019887586843, 0.21079723739348,
                       0.46396240220474, 0.90090380372330, 0.29132058037677,
                       0.80347070329277, 0.41006053878997, 0.56073402849150,
                       0.30433214035920, 0.35091211414361, 0.91979900344195,
                       0.18521465178124, 0.29687115576940, 0.01450459767356,
                       0.57172792357897, 0.69007175711328, 0.71862750937277,
                       0.44053735314524, 0.48332068024643, 0.43486522469115,
                       0.16241445666288, 0.69339442906310, 0.04214998765153,
                       0.66037428150435, 0.42965600281743, 0.29522849888337,
                       0.19949365187601, 0.30985192740763, 0.53775309234368,
                       0.63107825703754, 0.35891014261005, 0.80593306145117,
                       0.20637425949292, 0.82695739202104, 0.28458719875951,
                       0.67782736675766, 0.49453305972805, 0.27124031012380,
                       0.59433538963373, 0.67969529772615, 0.84072069013566,
                       0.29868204977061, 0.39908679401846, 0.87551387167815,
                       0.80148271437335, 0.74667391628212, 0.96444350343456,
                       0.35366110780040, 0.61993007851470, 0.65426564518563,
                       0.09897922173317, 0.35346683403716, 0.58703260685679,
                       0.53352972006590, 0.19234048095857, 0.41901228987087,
                       0.19245277953620, 0.03961121523159, 0.04715196513120,
                       0.56577130937026, 0.36509279964542, 0.60713434679622,
                       0.81134923996937, 0.20607514377105, 0.32393896567248,
                       0.75066714191421, 0.60142521608296, 0.48395538578485,
                       0.94671988681552, 0.66160162295953, 0.69741383642635,
                       0.69644445489803, 0.62964905866720, 0.78839569464935,
                       0.89518034508113, 0.52768172944128, 0.07397011618222,
                       0.52325065125277, 0.79308503761788, 0.15108253926394,
                       0.23703125352969, 0.72377886735702, 0.26126565158299,
                       0.04428493616243, 0.02055434227759, 0.93341488694742,
                       0.29158327115988, 0.05298282985489, 0.07196695966862,
                       0.85152206641230, 0.40863024094892, 0.74042255017963,
                       0.93784739545377, 0.99808717179228, 0.61040944770027,
                       0.46201716594551, 0.67547338431125, 0.89114488796574,
                       0.07180400034141, 0.55647093630101, 0.00492803284514,
                       0.97128756669521, 0.97925315263391, 0.99032568287048,
                       0.70512756442112, 0.02069437518722, 0.83780143727377,
                       0.19795031911432, 0.28902551734660, 0.87904482785041,
                       0.52327495421462, 0.77138472738785, 0.32239161184042,
                       0.84561170476675, 0.64631507073752, 0.64181609425718,
                       0.38186210557848, 0.64440971291039, 0.56654912010303,
                       0.21585811170298, 0.16438760656043, 0.66374541845007,
                       0.27097684876948, 0.96572969366588, 0.84086537938943,
                       0.49909120888126, 0.27807148665449, 0.54063119115150,
                       0.15955145271437, 0.13580716749908, 0.41323191201637,
                       0.63669497732347, 0.75065683921035, 0.17963987352042,
                       0.83831931031140, 0.74639169805231, 0.99270198565259,
                       0.03450742738618, 0.94695076320483, 0.78073814491931,
                       0.57290243994512, 0.17771353192029, 0.42450058404469,
                       0.88906139167840, 0.71025471235034, 0.12542686915562,
                       0.12072153585706, 0.48901272954413, 0.09471530764551,
                       0.90893711666445, 0.18515417023163, 0.31292535062617,
                       0.13576548474425, 0.57107463950211, 0.33186951492182,
                       0.05551033358040, 0.69854523331131, 0.58310032096512,
                       0.21025311256425, 0.68410868575796, 0.11977480038437,
                       0.35303156689542, 0.74097750685979, 0.18106650761959,
                       0.97268276440916, 0.04494918767408, 0.07156587037199,
                       0.65322604495761, 0.82968912548418, 0.88164637688174,
                       0.56060266712107, 0.94013229486336, 0.70949498620884,
                       0.26608827677078, 0.13924933635107, 0.82401960393812,
                       0.42017762685776, 0.35924615401548, 0.54656685403796,
                       0.78123210506865, 0.68243428250306, 0.60210628659504,
                       0.99166448767351, 0.67770443932562, 0.66196823291076,
                       0.77880482003236, 0.96166129443761, 0.68922433834454,
                       0.95969239335406, 0.59795097367489, 0.96887661250407,
                       0.74342788290558, 0.05397136989259, 0.55383608257132,
                       0.54691811795908, 0.97875472590961, 0.73253393215944,
                       0.05879977876146, 0.54688920134893, 0.00836903493786,
                       0.46797793846580, 0.98032715642447, 0.72703733602807,
                       0.77191291008003, 0.66468762315249, 0.73320740188036,
                       0.86786182726633, 0.40023532884031, 0.09203107710428,
                       0.50524642282657, 0.80551974214114, 0.70981255400005,
                       0.15002797828782, 0.56567664142338, 0.63637564197587,
                       0.74711629897592, 0.11272930447208, 0.26399301422563,
                       0.01601995081930, 0.64809716374687, 0.07102082721690,
                       0.17158137843734, 0.03371975035546, 0.42325637590495,
                       0.72477328888822, 0.75272941964178, 0.51940564146320,
                       0.85115976896618, 0.85965785613111, 0.93896960157714,
                       0.26606038849684, 0.84237945033811, 0.63000372254604,
                       0.77819072464975, 0.09617145984861, 0.82255249460579,
                       0.42753952670378, 0.87790169354534, 0.09526299905454,
                       0.93568759109297, 0.98281894416284, 0.50462981507196,
                       0.54653754145659, 0.23186628557976, 0.26605587743978,
                       0.95174887174386, 0.69235494194478, 0.47828192746691,
                       0.74218651870576, 0.56770788874214, 0.69789296716690,
                       0.60159624416009, 0.02541392168633, 0.46328941312000,
                       0.18666644630697, 0.76836775116843, 0.72186060181347,
                       0.74423292958394, 0.65738484008914, 0.90214074750105});

    ref = NDArray({8, 5, 1, 6},
                  vector<double>{
                      17.60056814324953, 24.44906290354863, 15.35507298563456,
                      21.44105804091966, 22.38946402938355, 26.94206313906709,
                      15.14757050424740, 22.09721027477789, 14.44594172508417,
                      19.04901022377718, 18.74204770827647, 23.09291030559594,
                      16.02915774544826, 23.66302383598268, 14.81488430518262,
                      19.72009287382355, 20.37827372478459, 25.17815699311604,
                      17.14194874848519, 24.26643079810395, 14.82095324213473,
                      20.55531370632657, 22.11549793967619, 26.85254528267726,
                      19.80299244331392, 26.34496508121632, 15.35455135792531,
                      23.12965108025080, 24.81497259309869, 30.16582864213485,
                      18.94732295428825, 26.07078911826718, 22.59110389268136,
                      21.89325098709569, 20.08829038887338, 16.51087446203505,
                      16.95970013484994, 22.77671614083993, 20.10285248922501,
                      19.59336013808728, 18.27249462765614, 14.85779140387926,
                      17.87242674373185, 23.95438714139318, 21.49989723534620,
                      20.38670782157045, 19.06081551081081, 15.11049268695190,
                      18.51981444534431, 25.11688695131931, 22.18722065530289,
                      21.21038235520632, 19.52283837179469, 15.51973862050470,
                      20.32018997526652, 28.58589349650941, 24.49414252066924,
                      22.97809376941919, 21.14435388096436, 17.56226063223011,
                      16.71740232600213, 21.00023806083207, 14.72027688051721,
                      16.51748290935820, 24.65078836774548, 16.95900294393475,
                      14.66421422330296, 18.10671469138883, 12.67358940236395,
                      14.11163584367297, 22.23598682815079, 15.20150499665624,
                      15.45162904260226, 19.75192388592808, 14.17531161059509,
                      15.03217265042926, 23.13114755905389, 15.43585616696400,
                      16.07762476388954, 21.08384230143067, 14.83709551092808,
                      16.14261991981662, 23.76728858505377, 15.87660213066449,
                      17.36160395726433, 23.39292876319950, 16.54193335042862,
                      17.96518412459944, 25.55268091881370, 17.24764969685243,
                      21.02403793832353, 26.32392137458100, 24.83640516135746,
                      24.22505117871917, 21.65717819431187, 28.06675770964011,
                      19.02403343526479, 23.07741440292620, 22.22798930190315,
                      21.43129933215858, 19.17670549243913, 25.26189516343808,
                      19.22574470029930, 24.20304786327072, 22.94167729903316,
                      23.05150671041986, 20.30566442616811, 26.07649489230813,
                      19.71264893324326, 25.37857291297555, 23.74940912242457,
                      23.95671073124503, 21.14058873719344, 26.82960261953243,
                      21.51942255108973, 28.16969511501839, 26.35549061717492,
                      25.72808724162432, 22.68560907784153, 29.77291275328063,
                      21.19236465221397, 26.27854786353010, 28.04354246365908,
                      20.88593986931585, 17.15602474119584, 20.29705375935667,
                      19.89107018050271, 24.30609385901611, 25.71065580670382,
                      18.45244273141270, 15.37724162250574, 17.90276298129495,
                      20.25402046601599, 25.32551211643080, 26.92250462721653,
                      18.94321561770419, 16.22175676941513, 18.45621925322979,
                      20.05333744180836, 25.40348573251577, 27.10898952712943,
                      19.68344083376980, 16.70725206064360, 19.16050099515385,
                      21.62768780154994, 26.65340820466614, 29.00571537092262,
                      22.04479097998045, 18.08531308822373, 21.66838970761273,
                      24.69099422942493, 21.23094374490757, 13.37409876671864,
                      23.41731181193137, 19.93456168984578, 19.47432037109374,
                      20.99205553510215, 18.50012181940427, 11.40342337375672,
                      20.47436593649270, 17.13799785684462, 17.15343644583436,
                      22.75510454694643, 19.73702016510280, 13.10471516019381,
                      22.33241589722360, 18.27028983209897, 18.33621542178263,
                      24.36578134491011, 20.83958143261501, 14.00295577128605,
                      23.47104482381200, 19.43820238531929, 19.02730961973537,
                      28.01014903856768, 22.75290998179882, 14.92732788786510,
                      25.79828742786919, 22.39966739187091, 20.82872979905825,
                      19.83512561611273, 29.62311394251308, 15.23734036783993,
                      27.92630808763068, 21.30279133807755, 33.30182496848804,
                      17.44509539561200, 26.92453485955785, 13.74900705778451,
                      24.80399051272182, 19.02431228602227, 29.46175434300914,
                      17.89856486879789, 27.53672181655044, 14.33024550235566,
                      26.05446353185665, 19.05550242128249, 31.26710785947748,
                      18.84324165161845, 28.19782206345287, 14.85820762433609,
                      27.10475427393196, 19.71273981910056, 32.58625886401222,
                      21.41958159660556, 31.01429860299787, 16.36635892338127,
                      29.15256662972844, 21.95398469058527, 36.05815647251564,
                      19.56391913217479, 20.39342215892062, 20.48247056628802,
                      29.67680431130432, 22.20762388828473, 30.05161599614913,
                      16.95552774834351, 18.33071971107402, 17.72075193868165,
                      26.95887696386963, 19.87581519726013, 26.24072299453561,
                      18.44079126928175, 18.85010265241158, 19.22478045716664,
                      27.64978282595913, 20.37814175425853, 28.02647696713428,
                      19.63383574027764, 19.47033419530925, 20.40474384577636,
                      28.20182310249787, 20.88971452776776, 29.34237837982398,
                      21.39257907735878, 21.48591997241012, 21.82663344022529,
                      31.24729122784465, 23.69116432626496, 32.48334894381173});

    diff = (NDArray::einsum("abcd,fdea,ficj->iebj", {a, b, c}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    a = NDArray(
        {2, 2, 2, 2},
        vector<double>{0.77118706504056, 0.91344266736563, 0.00364528099663,
                       0.51520809449774, 0.88227763478859, 0.58761828269996,
                       0.74527512145510, 0.37565894364018, 0.05101870798203,
                       0.37280067366274, 0.38107228632488, 0.50706994242094,
                       0.31211051732062, 0.81856381871261, 0.84201115537362,
                       0.81524833088722});
    b = NDArray(
        {2, 2, 2, 2},
        vector<double>{0.85231564629539, 0.89879402921708, 0.30473972866901,
                       0.70977854954655, 0.36944787696914, 0.64055200187476,
                       0.87654929203664, 0.40220108114301, 0.36308585651149,
                       0.15075893043986, 0.82333883518356, 0.02142640033622,
                       0.51240287668501, 0.88909562955867, 0.64204477268412,
                       0.96863461426519});
    c = NDArray(
        {2, 2, 2, 2},
        vector<double>{0.05454840447004, 0.70578968363000, 0.74920846608129,
                       0.29063048978213, 0.10471800200970, 0.58586417242670,
                       0.30920148769216, 0.10099881148501, 0.60769690738500,
                       0.02866931254949, 0.19590658767680, 0.26849379991313,
                       0.98391969312903, 0.61976456490809, 0.32288402689487,
                       0.02396683381228});
    ref =
        NDArray({2, 2, 2}, vector<double>{0.86461814846578, 1.29065623650420,
                                          1.61845569054687, 1.78061065875049,
                                          1.01464519064926, 0.39353277643496,
                                          1.54396992952951, 0.65957572884509});

    diff = (NDArray::einsum("abcd,acde,adef->ebf", {a, b, c}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    a = NDArray({4}, vector<double>{0.63665612279446, 0.99955707663753,
                                    0.01399527895261, 0.11945437933650});
    b = NDArray(
        {4, 5},
        vector<double>{0.09371919311520, 0.34443112104039, 0.57257556169095,
                       0.95068763535310, 0.35989362557971, 0.51609194514773,
                       0.30487471236883, 0.49653613348790, 0.54685877485706,
                       0.39452652977329, 0.03163789627643, 0.32191532523218,
                       0.80199042163090, 0.06636017102052, 0.43588428381523,
                       0.16549305300601, 0.36995989354541, 0.65410473142285,
                       0.87344137473067, 0.17912691300706});
    c = NDArray({5}, vector<double>{0.33638908910657, 0.88348330578878,
                                    0.26093294580268, 0.80905265828630,
                                    0.31345142274458});
    ref = NDArray(
        {4, 5},
        vector<double>{0.02007129350845, 0.19373391410123, 0.09511886186936,
                       0.48968810507774, 0.07182064813508, 0.17353080441755,
                       0.26923241656607, 0.12950524969008, 0.44224157957996,
                       0.12361012799368, 0.00014894675911, 0.00398035272203,
                       0.00292873217171, 0.00075139075105, 0.00191215465494,
                       0.00665003214887, 0.03904406880766, 0.02038817177519,
                       0.08441363959584, 0.00670707500509});

    diff = (NDArray::einsum("i,ij,j->ij", {a, b, c}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    a = NDArray(
        {4, 1, 3, 4},
        vector<double>{0.03829722388663, 0.08798855892382, 0.15978778409711,
                       0.41215954201639, 0.21985155958074, 0.86259182202665,
                       0.38764424550466, 0.42344796709829, 0.32564836942219,
                       0.87528926401427, 0.08609902650000, 0.94647665766787,
                       0.89995514948279, 0.89088968999966, 0.53797599997259,
                       0.85916791281370, 0.70732911240738, 0.68487857972720,
                       0.97553199194258, 0.25752985640065, 0.63048260254218,
                       0.97797142275486, 0.52584954277414, 0.58391859773912,
                       0.44856911201310, 0.70679654923449, 0.03075208049650,
                       0.98083378371408, 0.06826724086394, 0.59214960011895,
                       0.56376246122012, 0.51042003494891, 0.43635417044754,
                       0.68083225731690, 0.09442668032641, 0.34711098977754,
                       0.00518318320872, 0.67669741594223, 0.61738984293914,
                       0.93256226987954, 0.27528940658534, 0.11627965603781,
                       0.15846840167601, 0.58244172541262, 0.82184216339006,
                       0.30576291886014, 0.24901924540720, 0.34994402229903});
    ref = NDArray({1, 3}, vector<double>{1.89250126426233, 2.05093432594068,
                                         1.74799049480249});

    diff = (NDArray::einsum("abca->bc", {a}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    a = NDArray(
        {5, 2, 3, 2},
        vector<double>{0.30432388378185, 0.42186287082661, 0.47154383678652,
                       0.22296160272850, 0.29103968343146, 0.81840576552785,
                       0.22863596890943, 0.45935491108359, 0.01654462957640,
                       0.41364256365461, 0.75166392239575, 0.93711055717643,
                       0.17391382482966, 0.87301030757195, 0.00745994471559,
                       0.70710121267602, 0.22856980443451, 0.43634349389113,
                       0.50444538918816, 0.76613476314830, 0.72652494844545,
                       0.82703883577841, 0.52027174597806, 0.99381094172772,
                       0.80207808388231, 0.17456676315759, 0.04727265500449,
                       0.27836849561463, 0.26785254881915, 0.42730035676482,
                       0.10656352044002, 0.32405287827795, 0.60943968723116,
                       0.41710008902377, 0.14362106714719, 0.27890766653904,
                       0.15011803883601, 0.18925032960303, 0.78348583622303,
                       0.60880836480832, 0.02562821229410, 0.63840574535570,
                       0.15677252192345, 0.63551444896218, 0.16024328122343,
                       0.42826222788200, 0.83665970484104, 0.49509339583571,
                       0.23060008783997, 0.97667322580945, 0.54583886624407,
                       0.22443540024523, 0.47488052625293, 0.32132998004874,
                       0.27954288286204, 0.18568008523379, 0.74029964218449,
                       0.80535377281101, 0.37973860348434, 0.27295783105023});
    ref = NDArray({3}, vector<double>{4.03177100587560, 4.74699862812349,
                                      4.26585116756129});

    diff = (NDArray::einsum("ijkj->k", {a}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    b = NDArray(
        {2, 4, 7},
        vector<double>{0.13978662847780, 0.16109637357946, 0.07160995082548,
                       0.63222939521042, 0.46568649968256, 0.40979216803104,
                       0.95648762085743, 0.35317602717344, 0.88619064621795,
                       0.72682258062526, 0.89215990813713, 0.65649549929958,
                       0.31579009789210, 0.36365124226502, 0.24220195211653,
                       0.01486448434600, 0.87435807832582, 0.82988932610752,
                       0.61956518997279, 0.32910537613072, 0.66052240099960,
                       0.28567328211891, 0.51893987576376, 0.91220639660466,
                       0.18621353078155, 0.63507531651560, 0.02802627867591,
                       0.28162481817680, 0.85535601686517, 0.44323289340036,
                       0.77328652552999, 0.68104206488779, 0.81432690016194,
                       0.78436185099287, 0.47145819822656, 0.35451940137361,
                       0.87737079113945, 0.62539795041217, 0.42340845194506,
                       0.78718875059980, 0.37195105990547, 0.25450903049169,
                       0.04313377561016, 0.82097812306605, 0.02273703633383,
                       0.62408691493226, 0.27802324983889, 0.99317139011566,
                       0.64149214532977, 0.40793344536297, 0.67374078173852,
                       0.83938138084799, 0.51474480278191, 0.65766943142898,
                       0.00419587287475, 0.77396477223061});
    ref = NDArray(
        {7, 3},
        vector<double>{5.63330467474618, 6.69671332782036,  6.26089788651623,
                       9.30063608493215, 11.07409163135429, 10.42009342718185,
                       9.65353697301240, 11.33360319792587, 10.06180120463651,
                       9.53807603892689, 11.20036076651244, 9.95230583780903,
                       9.96303669087426, 11.74651234896977, 10.61678086816517,
                       6.90423400823055, 8.23623063170247,  7.80790584900828,
                       8.83448755951420, 10.38960903075285, 9.29066333607863});

    diff = (NDArray::einsum("ijkj,jlp->pk", {a, b}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    ref = NDArray(
        {2, 7, 3},
        vector<double>{1.69564636107548, 1.89426795118122, 1.31480936842369,
                       2.62624641133278, 2.93387496537724, 2.03639949029190,
                       4.29376770855157, 4.79672338928458, 3.32940059828160,
                       4.21984364953799, 4.71414014608885, 3.27207965709117,
                       3.94798280143268, 4.41043454828943, 3.06127792496009,
                       1.79842454708946, 2.00908518448884, 1.39450388783696,
                       3.75773391756411, 4.19790063099807, 2.91375835921533,
                       3.93765831367069, 4.80244537663914, 4.94608851809254,
                       6.67438967359938, 8.14021666597706, 8.38369393688995,
                       5.35976926446084, 6.53687980864129, 6.73240060635491,
                       5.31823238938890, 6.48622062042359, 6.68022618071786,
                       6.01505388944158, 7.33607780068034, 7.55550294320508,
                       5.10580946114109, 6.22714544721363, 6.41340196117132,
                       5.07675364195008, 6.19170839975478, 6.37690497686330});

    diff = (NDArray::einsum("ijkj,jlp->jpk", {a, b}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    ref = NDArray(
        {5, 2, 7},
        vector<double>{1.08913950300365, 1.68687809962326, 2.75795244542551,
                       2.71046989555998, 2.53584952907993, 1.15515549844027,
                       2.41364977117039, 3.00648561178696, 5.09603803140297,
                       4.09229747541957, 4.06058319060496, 4.59262118044751,
                       3.89839378093133, 3.87620904691488, 0.41848593303410,
                       0.64815825106773, 1.05970291152288, 1.04145843583496,
                       0.97436311260811, 0.44385161426160, 0.92740964194225,
                       4.29683293055497, 7.28319601558913, 5.84866213397857,
                       5.80333646109786, 6.56371873138021, 5.57153731536415,
                       5.53983116140694, 1.14048344679620, 1.76640048779583,
                       2.88796715423914, 2.83824619380757, 2.65539391740518,
                       1.20961155188430, 2.52743344887569, 1.69426220132765,
                       2.87179974495286, 2.30615603214909, 2.28828389805576,
                       2.58810633935619, 2.19688436326725, 2.18438247197490,
                       0.97922045996517, 1.51663358464440, 2.47961207423266,
                       2.43692159776806, 2.27992441319040, 1.03857393418791,
                       2.17005740091346, 2.58919377270539, 4.38872212946861,
                       3.52429797031909, 3.49698554000981, 3.95517813695501,
                       3.35730756919919, 3.33820201454784, 1.27739433788128,
                       1.97845044387069, 3.23465711069755, 3.17896732974743,
                       2.97416430239858, 1.35482102064117, 2.83084264487573,
                       2.09941769202741, 3.55854435505281, 2.85763606759072,
                       2.83549010076196, 3.20701024518809, 2.72223384076412,
                       2.70674232372361});

    diff = (NDArray::einsum("...jkj,jlp->...jp", {a, b}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    a = NDArray(
        {8, 6},
        vector<double>{0.59563336772593, 0.68790648286565, 0.23608140930493,
                       0.74403209110638, 0.60900869716044, 0.78067582500023,
                       0.86441222945629, 0.79990764173189, 0.38702894725816,
                       0.31238637973187, 0.31686914328564, 0.48294064203426,
                       0.48229240121013, 0.72023549140833, 0.75976672053652,
                       0.63658163842461, 0.81527384930214, 0.37117455778738,
                       0.18748642418855, 0.43610653441676, 0.88065540180783,
                       0.63848286214380, 0.72164803137018, 0.94341138461399,
                       0.79030988372665, 0.76629056872763, 0.15753541049795,
                       0.80924574919644, 0.49577412110816, 0.61849462809326,
                       0.12770529648862, 0.83628694982719, 0.16511955675361,
                       0.56259038406342, 0.71403175195068, 0.43724108187811,
                       0.68689757491981, 0.57011122702478, 0.91533920956327,
                       0.27764981395508, 0.34428775878718, 0.01401438406140,
                       0.57833792659770, 0.64279042087675, 0.50154865917976,
                       0.74235259634666, 0.00339979562403, 0.48217328082506});
    b = NDArray(
        {8, 6, 6},
        vector<double>{0.76063951286588, 0.01343218200369, 0.57988254501000,
                       0.93500613218573, 0.79190639679273, 0.85804800898717,
                       0.50081226521914, 0.34420459295853, 0.72981732272740,
                       0.37176776208998, 0.34689935755515, 0.50160624539063,
                       0.83683653102799, 0.79463802912157, 0.20404555079615,
                       0.53587328969188, 0.69731848160272, 0.64030008096291,
                       0.61079581619502, 0.48224293441634, 0.06458626928331,
                       0.26639941156735, 0.76641550008111, 0.40138782699225,
                       0.73152746286503, 0.84313984716273, 0.97797906409885,
                       0.85665519079219, 0.63556706507937, 0.79987185623388,
                       0.16574947345294, 0.02547514529009, 0.92831736844095,
                       0.48301457135575, 0.39218194528341, 0.83930573064613,
                       0.11483626654385, 0.88628341681523, 0.76875381315535,
                       0.39737808992021, 0.09770546525525, 0.79446101361735,
                       0.77356783537620, 0.15830020204935, 0.65950121359212,
                       0.58060560307528, 0.86257476849448, 0.44914191855706,
                       0.31568098175429, 0.61964858490550, 0.18189092597902,
                       0.21816501945959, 0.83891091331024, 0.18980056059759,
                       0.45863055739812, 0.22532233026513, 0.84944959776626,
                       0.03878267166968, 0.87599246565301, 0.82497679422428,
                       0.34992698292579, 0.67307427132745, 0.00307739327060,
                       0.01793643785230, 0.64514204001346, 0.85600528983871,
                       0.98521239498348, 0.99028519007753, 0.01488254541050,
                       0.53078836310413, 0.10039138602643, 0.50710217097707,
                       0.89080772548262, 0.02688302516072, 0.25038762382009,
                       0.09038132753434, 0.46673026434102, 0.85016573557838,
                       0.96152402290278, 0.16083918541707, 0.39644305935984,
                       0.20182765403197, 0.30553636345806, 0.33448310248061,
                       0.82766318105771, 0.97897463418872, 0.94954394302523,
                       0.43206280444810, 0.34084443751507, 0.71528287747199,
                       0.43843185072343, 0.47704137920914, 0.05417549189748,
                       0.58548884590232, 0.98379025936533, 0.52297020795461,
                       0.57269933234366, 0.70195619622852, 0.14685947520609,
                       0.45609095944776, 0.66196862332022, 0.00317324338701,
                       0.58513436384447, 0.35615697207551, 0.49196429249286,
                       0.17932906163317, 0.59331399106979, 0.79600329644099,
                       0.11392180357456, 0.59594447430973, 0.76490291882625,
                       0.37216663540132, 0.03240931487946, 0.36876356609316,
                       0.35824304542408, 0.39472762354930, 0.67932850315106,
                       0.75314793600409, 0.43938870174226, 0.71258679236305,
                       0.20675119011311, 0.92839600297193, 0.06851390601650,
                       0.70160737571945, 0.71749275320409, 0.39040274398432,
                       0.71140866479633, 0.94866239140420, 0.88106937019634,
                       0.67473616509888, 0.29719984024374, 0.27329142135607,
                       0.97292896649953, 0.56516355078326, 0.48808355351934,
                       0.91322314525553, 0.85295079141860, 0.91772908321807,
                       0.31898916774081, 0.91103867187262, 0.87628919464209,
                       0.13070067104762, 0.18334154487694, 0.53420309328098,
                       0.49315062128630, 0.65058103895421, 0.66235721477264,
                       0.96040427642722, 0.73128703067546, 0.97391555992810,
                       0.49981678871342, 0.55612177807606, 0.92642529518880,
                       0.37486119929406, 0.33774487620372, 0.72598030491224,
                       0.82608360254029, 0.01682208851895, 0.68890226665693,
                       0.21605254589912, 0.53477875828332, 0.67733560038927,
                       0.11384754326583, 0.69490836074186, 0.26596036075738,
                       0.78983557775492, 0.40620203434743, 0.98519212841806,
                       0.99428213638637, 0.99192475948044, 0.86766071159449,
                       0.46495427130189, 0.94721308432107, 0.65154618757078,
                       0.52553956850138, 0.22575967924313, 0.58051418009534,
                       0.53345854394645, 0.61783780144722, 0.39817076173916,
                       0.06380607578342, 0.65798211499331, 0.25053700728611,
                       0.04490719626544, 0.22971263469572, 0.04799538782109,
                       0.52521068919043, 0.14687907609218, 0.82845308964451,
                       0.03951437331877, 0.77307836476089, 0.58100040523598,
                       0.31770301089875, 0.72912326986187, 0.64862939745257,
                       0.77789754845979, 0.06480326046835, 0.43477338655424,
                       0.50047220753789, 0.93160065982203, 0.19329636717336,
                       0.56553372019650, 0.55670100359879, 0.70004561501468,
                       0.75857764464762, 0.73696919805941, 0.61575637243141,
                       0.63586208434493, 0.62244365051698, 0.90895939846654,
                       0.34858168182441, 0.39297667507205, 0.72085560818346,
                       0.89758755561398, 0.75341530937941, 0.58386179009040,
                       0.32633203845644, 0.66039742789967, 0.16009612745566,
                       0.35535835587244, 0.87413722846420, 0.56282954699834,
                       0.69195028303864, 0.32567719590441, 0.21913726858011,
                       0.61155084135593, 0.49684660240687, 0.30876956977788,
                       0.44182639779493, 0.67098374003914, 0.62364020048749,
                       0.57047992597991, 0.49460447154512, 0.67672880673396,
                       0.24978881058019, 0.37187457677919, 0.73322539628575,
                       0.48908430119549, 0.26049880049219, 0.38319352625093,
                       0.55421807465432, 0.20219722848430, 0.45304448867914,
                       0.95554473944200, 0.72356482066678, 0.08924656094678,
                       0.86930056969743, 0.58750963570634, 0.85203357991064,
                       0.00177778492306, 0.12583408393664, 0.91803463427158,
                       0.93271072571318, 0.77151063779076, 0.17178280604420,
                       0.03668667910742, 0.27890260074048, 0.26047701401445,
                       0.91219503341535, 0.08778712519920, 0.95956697048719,
                       0.73340125981389, 0.89955737149701, 0.18031633625637,
                       0.51257585757318, 0.22168598600889, 0.23848118209367,
                       0.06783581208705, 0.90231980015830, 0.87269204466009,
                       0.10919709099059, 0.67070642678258, 0.15996947623782,
                       0.24991243007101, 0.23526692564607, 0.66142631013273,
                       0.74682746028611, 0.88140282207664, 0.97265136816846,
                       0.81157004050147, 0.55929486389096, 0.14011688688422,
                       0.25720087199628, 0.38988244130892, 0.40279834555270,
                       0.61543047713103, 0.29918355084282, 0.57102933353323});
    ref = NDArray({6}, vector<double>{12.94849347299722, 16.28592379796587,
                                      12.24054254824305, 14.56315041158197,
                                      12.56191274271473, 12.03353778860282});

    diff = (NDArray::einsum("in,ijj->n", {a, b}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    a = NDArray(
        {6, 6},
        vector<double>{0.13440349118039, 0.48702128656025, 0.11826131977432,
                       0.65669379819947, 0.00863572298660, 0.66116062861272,
                       0.59166345367688, 0.91569998888876, 0.63538454177087,
                       0.56282248134934, 0.18638975376826, 0.66093877501140,
                       0.30798646471634, 0.18525825038078, 0.49741491467970,
                       0.50499101007679, 0.40380459834421, 0.54830931374570,
                       0.17166881586184, 0.98982324220419, 0.97391759088866,
                       0.84901770694210, 0.48685344563755, 0.74180586198982,
                       0.08848059800264, 0.92225361578184, 0.67784902555940,
                       0.47605662193459, 0.18283506052262, 0.11997043857923,
                       0.31356766309056, 0.26055285901924, 0.14397782825861,
                       0.84929449145547, 0.46572469964684, 0.74672626056013});
    b = NDArray(
        {8, 8},
        vector<double>{0.29775396658070, 0.93224675228582, 0.62865396568768,
                       0.90893252239890, 0.12526687252201, 0.42126487146986,
                       0.67804120435326, 0.80247006246025, 0.73381010159452,
                       0.61253477266867, 0.79010694987414, 0.08319043697509,
                       0.58883895306301, 0.46613139584251, 0.95274525306866,
                       0.16857763793079, 0.44928417751914, 0.91329933192539,
                       0.87450467091737, 0.81436690231097, 0.90319358234083,
                       0.05770591981830, 0.63353774315941, 0.92463104669850,
                       0.72971459832100, 0.97459962019787, 0.46581613988200,
                       0.53531731900201, 0.40690530452685, 0.51377777099694,
                       0.64972803881242, 0.05634671999858, 0.72916259576694,
                       0.01359445604636, 0.13211669074682, 0.16812107324092,
                       0.26955748593535, 0.34330065956949, 0.90785233747122,
                       0.74135249319049, 0.60645357380229, 0.93971548939761,
                       0.56948709610537, 0.01624901300420, 0.66541103296299,
                       0.37176553457924, 0.22322845861412, 0.65898024746119,
                       0.51035003391970, 0.40498745646109, 0.71857072158894,
                       0.92919693068553, 0.84686165262043, 0.17865636931599,
                       0.79459601697229, 0.83182189755657, 0.57483581870534,
                       0.80335173247126, 0.02974488863432, 0.83211312885640,
                       0.89028575741070, 0.68708942593987, 0.45659723954980,
                       0.47922961363778});
    ref = NDArray({}, vector<double>{14.08688530957203});

    diff = (NDArray::einsum("ii,jj->", {a, b}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    a = NDArray({6}, vector<double>{0.33241210899114, 0.27348724540786,
                                    0.17810871332586, 0.65516551673360,
                                    0.57542400626783, 0.68304498629715});
    b = NDArray({8}, vector<double>{0.13238210129031, 0.04095876286369,
                                    0.35844764150925, 0.01468896997434,
                                    0.08408968421967, 0.68660266337738,
                                    0.23145089791755, 0.71726458239857});
    ref = NDArray({}, vector<double>{6.11254866951024});

    diff = (NDArray::einsum("i,j->", {a, b}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    ref = NDArray({}, vector<double>{1.44392089197911});

    diff = (NDArray::einsum("i,i->", {a, a}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    a = NDArray(
        {6, 8},
        vector<double>{0.13267658024466, 0.79296582721832, 0.08651683561611,
                       0.67311612872657, 0.35682224045233, 0.68250751879619,
                       0.86129605116601, 0.34656889889718, 0.63680252572283,
                       0.97387260627695, 0.56478569782720, 0.10830981741377,
                       0.53805103500080, 0.27590811277493, 0.34038852796666,
                       0.92731278556273, 0.05120616632480, 0.73883264864222,
                       0.39080186886819, 0.91388952348789, 0.17006194056398,
                       0.26617374935549, 0.59151690081826, 0.63756653204420,
                       0.90670745024528, 0.05791057269041, 0.04312359385742,
                       0.05941806510056, 0.88222806701653, 0.79179237736867,
                       0.24071472525074, 0.88993678516814, 0.33747179974666,
                       0.39877335666682, 0.87967181030971, 0.50596341548997,
                       0.75114601136499, 0.34984906253065, 0.05203903225269,
                       0.67199296437937, 0.71658482127711, 0.66164702131818,
                       0.83503469217446, 0.36028006831898, 0.90718027720205,
                       0.55471598679845, 0.37853524170520, 0.47596000114649});
    b = NDArray(
        {8, 6},
        vector<double>{0.45510282835763, 0.90306118648099, 0.07853388946732,
                       0.95492890184999, 0.99627438576361, 0.68522506332730,
                       0.51687045503003, 0.71257816155358, 0.13638223160544,
                       0.01390426437372, 0.07419845364816, 0.00320297702214,
                       0.11888488441330, 0.40440624127816, 0.13823202276257,
                       0.16540871513754, 0.56987821498671, 0.42776509370134,
                       0.46925707839826, 0.09253591046506, 0.44337368089688,
                       0.60560593620256, 0.31910960847017, 0.27828971961592,
                       0.13863822270186, 0.31764782524971, 0.73038726265400,
                       0.29603771381020, 0.93711262160918, 0.15721013217164,
                       0.31048552319652, 0.84852045864979, 0.81152254142191,
                       0.58562429328827, 0.29650912640560, 0.10711169470120,
                       0.46517141828037, 0.03656752754523, 0.09289881515333,
                       0.10836762084287, 0.52438151477036, 0.64686955442386,
                       0.80062640950557, 0.50101810609922, 0.43522089971860,
                       0.03162056730487, 0.08447997753825, 0.49836318139871});
    ref = NDArray({}, vector<double>{10.60589549959826});

    diff = (NDArray::einsum("ij,ji->", {a, b}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    a = NDArray(
        {5, 4, 6},
        vector<double>{0.75015266115216, 0.57882799505473, 0.96716834441764,
                       0.42637604994250, 0.06213541997026, 0.25416217280805,
                       0.94671603164721, 0.22290229073134, 0.96263513340701,
                       0.19829075078147, 0.33953091054317, 0.81570593461967,
                       0.85113589983709, 0.56690728214272, 0.90368642871019,
                       0.51479170854923, 0.21414855379199, 0.86337861529545,
                       0.01217729323675, 0.61563261338523, 0.01974288182679,
                       0.89757184385698, 0.15597163673596, 0.46857720708779,
                       0.77346752029895, 0.80387147594532, 0.95419509899189,
                       0.57745914495206, 0.03999808653438, 0.03004650565725,
                       0.12296020653465, 0.48406440136807, 0.85500336205842,
                       0.45538482147272, 0.26242516714305, 0.83773716460674,
                       0.88163916437922, 0.11458565402803, 0.47347233305282,
                       0.30482216311972, 0.40790580722612, 0.59966531879068,
                       0.56908632797726, 0.86492247216114, 0.70829241818846,
                       0.43192619960958, 0.30867974802230, 0.29480773328752,
                       0.51294504022321, 0.65423817781580, 0.84420733009630,
                       0.34678241729247, 0.95920690555883, 0.84471616255290,
                       0.56681136310473, 0.07421249714314, 0.69608953189728,
                       0.62851058244377, 0.42885286197953, 0.89348777314944,
                       0.82797924523304, 0.35963589198164, 0.54448143360284,
                       0.76263110294991, 0.83857550744661, 0.27761989811345,
                       0.60951394056839, 0.46011425945426, 0.07717791163732,
                       0.36545036134982, 0.73808940764695, 0.35998387419696,
                       0.51302677723124, 0.26638100602146, 0.78983185079434,
                       0.36796259507884, 0.81193045907358, 0.69027034596953,
                       0.98057169502243, 0.52987887069871, 0.92073311874417,
                       0.70748507515583, 0.36600149682722, 0.87785024977313,
                       0.33046029239105, 0.03899161258137, 0.99625722759198,
                       0.96613326339902, 0.21340292225718, 0.83285734946893,
                       0.45643393037058, 0.10276243546310, 0.49745782082526,
                       0.38555698712746, 0.86104941148826, 0.77765225224843,
                       0.62683386751589, 0.68513595509995, 0.21388099756796,
                       0.77642452528769, 0.66272322314797, 0.24804323774901,
                       0.07180723587961, 0.43820873941656, 0.35730482856434,
                       0.38145128818816, 0.56708115434771, 0.60833629346521,
                       0.23931296559572, 0.90467708139039, 0.13801820714217,
                       0.66009916585410, 0.78960987927151, 0.16227839209836,
                       0.83152248992662, 0.87473055089237, 0.34885440329208,
                       0.36345579799544, 0.72099259344347, 0.54858855539002});
    b = NDArray(
        {4, 9, 6},
        vector<double>{0.01079070548547, 0.51769448391310, 0.03926143395604,
                       0.89802727669451, 0.08582932687785, 0.37264547950418,
                       0.57617257828036, 0.13934244544867, 0.18749468636227,
                       0.14300544887933, 0.03957805637108, 0.37727824243305,
                       0.63389032574266, 0.86449931907591, 0.88917610876601,
                       0.37864655741317, 0.77367508764985, 0.15716505592595,
                       0.66061182380259, 0.40551878882804, 0.07351880335652,
                       0.83707576287405, 0.60695170219164, 0.49265005426475,
                       0.75973154543120, 0.43636438345205, 0.89773558797031,
                       0.22881579038510, 0.25072226398085, 0.68972378632073,
                       0.83359747719742, 0.84695794886084, 0.53252339785523,
                       0.84158759912505, 0.20890030507412, 0.49972758771154,
                       0.59138862291607, 0.23385076867135, 0.22956783679657,
                       0.43435071671555, 0.95755884465884, 0.99690123602194,
                       0.33219602291430, 0.89862322829122, 0.96251748987436,
                       0.35849109243326, 0.51028715739833, 0.70524519676657,
                       0.44394675138036, 0.09719083560255, 0.61966025465586,
                       0.83187430268758, 0.97749367279627, 0.10537717636772,
                       0.57288190843020, 0.76122955796692, 0.44632509367643,
                       0.99067996992531, 0.59877185425594, 0.77390773403126,
                       0.01350045440369, 0.30280238717969, 0.04075175506453,
                       0.74063527924943, 0.63373342844884, 0.09581858871722,
                       0.20776464578652, 0.31952350706616, 0.05546447916864,
                       0.35443024663489, 0.34390905808654, 0.46647742626325,
                       0.19473638885134, 0.31807192978179, 0.81142417295082,
                       0.77800170748875, 0.35174328344817, 0.84601023602439,
                       0.46889606305169, 0.82779482461869, 0.32452552966075,
                       0.54198758999152, 0.85321464864769, 0.84749099129378,
                       0.71731689287228, 0.05576894404159, 0.20757811045910,
                       0.03975396974659, 0.15092181237419, 0.36646709233947,
                       0.55728458485697, 0.76756171961737, 0.15276240566921,
                       0.08932365602145, 0.58904601839462, 0.43544684314887,
                       0.46899252747765, 0.35133636676840, 0.30654154753945,
                       0.76039802458575, 0.09371308132718, 0.07672721651454,
                       0.62887095928767, 0.64177649917972, 0.83284716861979,
                       0.17629712227835, 0.42710631443550, 0.43250238903051,
                       0.46000285840608, 0.69534065875469, 0.62399524241003,
                       0.01450066619857, 0.46932972947464, 0.09673294509466,
                       0.81804349768481, 0.21012579663250, 0.07867744880610,
                       0.78700615749702, 0.82262888542774, 0.41115657937322,
                       0.97914042076021, 0.68096858845833, 0.34000830596162,
                       0.77251008201098, 0.04833244218008, 0.02463760080099,
                       0.48780325243159, 0.39895016216436, 0.11638449027607,
                       0.12168466382259, 0.05358830967334, 0.32661701524660,
                       0.58016877023223, 0.65115155561688, 0.06662133488811,
                       0.46147173311773, 0.40647347514406, 0.38942286583677,
                       0.04982401095298, 0.26663470683761, 0.85392021415365,
                       0.60186849346221, 0.42993711985267, 0.85368820329356,
                       0.97379918047322, 0.89584884997098, 0.07382468054082,
                       0.04290177455650, 0.10268234496979, 0.95880885929702,
                       0.29579019948180, 0.33910879970772, 0.61789760856337,
                       0.85691813778536, 0.17256909728562, 0.21014451413969,
                       0.59175151309647, 0.22482050693525, 0.15791472873051,
                       0.12898577533060, 0.72329273176303, 0.08964059612900,
                       0.40933386441724, 0.86910679888137, 0.48461057436816,
                       0.14586748732276, 0.64795286837837, 0.07703507512179,
                       0.37720711390541, 0.11437071303308, 0.81688145461979,
                       0.96236113832804, 0.43916594297233, 0.20957537221825,
                       0.55626760277682, 0.57868711759758, 0.02597363249244,
                       0.24338487705378, 0.08110108232641, 0.33815273015439,
                       0.27318236744082, 0.37236351386396, 0.93002091954318,
                       0.37714301339999, 0.25988167373948, 0.26793939252495,
                       0.29752657777369, 0.16676428673168, 0.17880016635629,
                       0.52515721607474, 0.41372528846385, 0.46121241024725,
                       0.55767200723267, 0.09360786405408, 0.10662267282685,
                       0.38576589625551, 0.72177461031284, 0.35649349230506,
                       0.06746849387587, 0.22511803268242, 0.24626235996088,
                       0.49772580923292, 0.51080310400599, 0.80433413596035,
                       0.08909851933570, 0.07063428495752, 0.10348244951475,
                       0.50425071089554, 0.22269991345269, 0.89167534206196,
                       0.56979493272590, 0.01670116718781, 0.04541207969939,
                       0.61467688815196, 0.48989744338516, 0.48938568194060});
    ref = NDArray(
        {9, 5},
        vector<double>{5.36016707712046, 5.72048656130409, 5.99695743749974,
                       5.99407960851937, 5.99208153577330, 4.35763313637872,
                       4.70874842492356, 5.12939158577829, 5.01493572121650,
                       4.68854086541102, 5.68331589434442, 5.59564439182342,
                       6.36979785223896, 5.56296047815756, 5.57392528370209,
                       5.17955034746223, 5.70063039318285, 5.72425204741619,
                       6.07118428649496, 5.35432148094255, 6.45429849283120,
                       5.96278666349702, 6.83931787017882, 6.91550366941221,
                       5.82433237563835, 6.17543757980900, 5.31839412908583,
                       6.16985445988418, 6.85369678805787, 5.29160601536322,
                       6.04061993426396, 4.95764625777041, 6.30420262773614,
                       6.65315641925677, 5.51113574067606, 5.74033563652281,
                       4.85565824158576, 6.19663954418839, 6.71627047492367,
                       4.71210596118263, 5.45178788216804, 5.13239788365072,
                       6.30122448937106, 6.33887590828429, 5.38071460598809});

    diff = (NDArray::einsum("ijk,jlk->li", {a, b}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    a = NDArray(
        {3, 4, 5, 6},
        vector<double>{0.41746307090286, 0.79917369476980, 0.74044822110599,
                       0.50431392972050, 0.21611371274876, 0.05389832477216,
                       0.13001351412978, 0.10043407497797, 0.54462027904412,
                       0.51922853706135, 0.46101171264691, 0.66558825755825,
                       0.58016637711816, 0.08898665375631, 0.60342672933963,
                       0.84892390199833, 0.98635845164371, 0.29639891324777,
                       0.13769249309537, 0.06447604622988, 0.29599731720249,
                       0.75747211483176, 0.17423362092380, 0.77622854545746,
                       0.91752418063457, 0.91407264914910, 0.93514988319888,
                       0.62246405825615, 0.22376315395105, 0.23853623962121,
                       0.42275754366902, 0.61060583799787, 0.09913018950488,
                       0.04833106976093, 0.62149876709662, 0.08679083407111,
                       0.37615720641019, 0.10942268879497, 0.64752474822804,
                       0.61096616393903, 0.65854910658056, 0.37582037804334,
                       0.58418396842815, 0.81528270141998, 0.48450341633890,
                       0.27240262324778, 0.07175105165060, 0.98892713396261,
                       0.17182131080277, 0.72458824599316, 0.76796213158124,
                       0.36187640608153, 0.21330427318948, 0.40145645716719,
                       0.90772913243558, 0.57612249815156, 0.10706294676138,
                       0.02683017709732, 0.45809062106459, 0.41844379108790,
                       0.77010123637408, 0.89412243547212, 0.41873348872717,
                       0.51498078648772, 0.64843525634368, 0.26933002056263,
                       0.50843482431491, 0.27486358165822, 0.71388909487410,
                       0.12421484474539, 0.99057311409283, 0.43994120795689,
                       0.65443517452062, 0.41777886977354, 0.06467094858316,
                       0.26559005861034, 0.75269748947946, 0.27687132092894,
                       0.60412582141178, 0.35490269640755, 0.53907130871927,
                       0.03574815779942, 0.92482826099446, 0.72861274024856,
                       0.78103730763060, 0.66327299379397, 0.89806457296377,
                       0.81177818334647, 0.76453258913064, 0.40068164906861,
                       0.41477924262815, 0.50742359857612, 0.90958274461011,
                       0.69747892983566, 0.83797130955619, 0.11149909274334,
                       0.57537275363430, 0.21757120018744, 0.90472331971352,
                       0.70062085973058, 0.50325822316750, 0.05100568058938,
                       0.86402950862209, 0.98128112400470, 0.68949126913108,
                       0.66027053465428, 0.62658449321610, 0.80778496283820,
                       0.01877688386922, 0.07498064265464, 0.55023773763218,
                       0.02997157204824, 0.39051250656340, 0.86298850441417,
                       0.92785741580692, 0.69151628084279, 0.34894909904504,
                       0.66225718052314, 0.52179003249618, 0.98305169257167,
                       0.55901938336251, 0.50713355016100, 0.28423779886977,
                       0.40231571736061, 0.65683258085021, 0.37557159164694,
                       0.81290431679317, 0.30478517329346, 0.29066305762364,
                       0.63237099142607, 0.14066279369997, 0.38465463657857,
                       0.49889453999301, 0.14047441522440, 0.85833412305645,
                       0.64548258088379, 0.76204671500643, 0.75794158176766,
                       0.66381054168620, 0.71293667742466, 0.33917702380034,
                       0.72322779194114, 0.66268085727191, 0.77391868374555,
                       0.68798730541958, 0.02614291497099, 0.06510888247988,
                       0.13245367810644, 0.69825655496694, 0.11298665519779,
                       0.54671369478709, 0.73301720287011, 0.54070315676008,
                       0.30803945758504, 0.70188522452563, 0.45994471518691,
                       0.18845821747345, 0.45003726458405, 0.58655075509527,
                       0.49551522687166, 0.60346240028604, 0.89329662247956,
                       0.15164599926697, 0.16436680900861, 0.90322594859813,
                       0.85663876004880, 0.59969277351864, 0.12644659230227,
                       0.38280932771917, 0.65935834886753, 0.70716936164282,
                       0.67401028582355, 0.79117968840979, 0.06703377324272,
                       0.92746416721952, 0.81645811383264, 0.39225961751221,
                       0.05886013871295, 0.92839324850155, 0.50990171592710,
                       0.12865138248483, 0.83769022137131, 0.43905560944502,
                       0.50133711565813, 0.68582155886405, 0.57894278823543,
                       0.06942174622631, 0.25104634487964, 0.75586329502023,
                       0.61279927770401, 0.53791239994244, 0.04555190120689,
                       0.47055907847350, 0.50650280501367, 0.09378359506653,
                       0.12491844609933, 0.16529643707555, 0.30002237464751,
                       0.42137056978991, 0.19260093215085, 0.45913603300148,
                       0.82754444587098, 0.39774866879957, 0.07029121992145,
                       0.14738200196092, 0.49235102834379, 0.58970260236629,
                       0.41571356516448, 0.08944971008521, 0.65072057784626,
                       0.33154537716443, 0.70513511699171, 0.06021992598488,
                       0.68600205867793, 0.93553870280115, 0.42195195979204,
                       0.83767574858637, 0.32092691748272, 0.72805886496023,
                       0.40350208241995, 0.25592493361122, 0.95948904453984,
                       0.36106364576393, 0.20540649140131, 0.71428126983896,
                       0.85925856709882, 0.23349153855561, 0.48323541009229,
                       0.17129036401327, 0.77075362886242, 0.00441586865773,
                       0.92377855476664, 0.94553023100903, 0.59608258921925,
                       0.31845212755202, 0.96409720768042, 0.95136703242306,
                       0.77144684956615, 0.84454455802433, 0.23796083438792,
                       0.72865218942185, 0.23825344852824, 0.48057374384652,
                       0.72437061708531, 0.71502810979599, 0.76411535023572,
                       0.39294321943150, 0.76420585544605, 0.31591943753651,
                       0.27113230323119, 0.23702937127141, 0.65843584223176,
                       0.17618726242836, 0.16543584606931, 0.81015897178883,
                       0.07469407298408, 0.21861181095098, 0.90070948629708,
                       0.61765977670577, 0.23279561629656, 0.81355867933362,
                       0.68114273104732, 0.99380840063748, 0.28960728650413,
                       0.88306550947282, 0.86829556666047, 0.34062923059537,
                       0.41897139124443, 0.97197370233077, 0.46201720813658,
                       0.37261711454780, 0.34443382752871, 0.34679247131191,
                       0.32410232460006, 0.93780772031060, 0.99026612370140,
                       0.60933723496056, 0.41869124974279, 0.89967648434027,
                       0.85323009423603, 0.21622494196160, 0.39791438467422,
                       0.34571611546120, 0.31268871758872, 0.07056574478884,
                       0.24163648591974, 0.52864364392952, 0.22795480876525,
                       0.07885158750213, 0.40503037379331, 0.92572390982709,
                       0.55139696091534, 0.35907594656759, 0.38562519862377,
                       0.82632531746973, 0.34729935541104, 0.93011841539593,
                       0.75944781277234, 0.19870749110456, 0.77009242210810,
                       0.88734118217602, 0.16720926914064, 0.16760478693637,
                       0.27846045233515, 0.38735582647373, 0.60319827122436,
                       0.20922081317115, 0.88309456229260, 0.68543171003965,
                       0.07294132627858, 0.51959081222826, 0.71983276010995,
                       0.46872868393708, 0.44076089852638, 0.56201096927222,
                       0.01302414234201, 0.62939374965826, 0.49191647045949,
                       0.06282232607470, 0.49462336854827, 0.81277047182439,
                       0.66210310934307, 0.14193754414280, 0.67985829551325,
                       0.83048752100506, 0.25989154703088, 0.14884778655013,
                       0.10888461689708, 0.63421247782975, 0.15203476523086,
                       0.29281161634779, 0.64794670908069, 0.61360558875105,
                       0.44749190648081, 0.74325745479151, 0.26625567582811,
                       0.28041406602015, 0.52007411068673, 0.77069024589198,
                       0.51825707054346, 0.31345245175836, 0.94805756065446,
                       0.39959704793866, 0.95682421814979, 0.14263539680412,
                       0.36424857607533, 0.76562837693347, 0.11991544925574,
                       0.21021965034036, 0.51508180818634, 0.61773519001583,
                       0.00129575213855, 0.09610365328464, 0.71762326507311,
                       0.85527594364150, 0.94171894887976, 0.80704161357389,
                       0.82837037083307, 0.12971573811040, 0.13429511331835});
    b = NDArray(
        {6, 3, 5, 2},
        vector<double>{0.71776471577939, 0.89800819940277, 0.61823164013376,
                       0.18274515506273, 0.25081088704304, 0.75061854426033,
                       0.14554913786167, 0.30156727269470, 0.07923793651333,
                       0.51415078049122, 0.30265886581524, 0.87736770045221,
                       0.21817093166297, 0.58375878984878, 0.60808374976772,
                       0.56030044343840, 0.35125262068844, 0.97957692197361,
                       0.33097908321058, 0.03354536549103, 0.04596493196470,
                       0.66730791524622, 0.36092283784910, 0.23560491245084,
                       0.29192978325328, 0.57212554794434, 0.61663462374087,
                       0.19768478947636, 0.99230075197500, 0.29594621377050,
                       0.88073107792041, 0.71622924127838, 0.80610701860769,
                       0.46757692253959, 0.97485080933462, 0.84049755855396,
                       0.27937289538427, 0.82949127855427, 0.88835039973138,
                       0.86385570740916, 0.91221696263178, 0.47170282017238,
                       0.92235552072181, 0.71690674507723, 0.92662905258051,
                       0.99802134919821, 0.28152542440979, 0.03590148135592,
                       0.28056102328500, 0.09658803565498, 0.07196826839932,
                       0.89278700835290, 0.50091516996748, 0.82880776851974,
                       0.36725227205517, 0.44366242296629, 0.15340066232090,
                       0.06500836755082, 0.32179824354024, 0.58726661446917,
                       0.73532582679347, 0.49635936195366, 0.49771917218855,
                       0.83839525191269, 0.31546631045746, 0.72142350683608,
                       0.93363169902650, 0.20609900417053, 0.79214133113131,
                       0.37965522075647, 0.66834556975645, 0.72476749193853,
                       0.13790535359286, 0.71744265301758, 0.09286501848069,
                       0.62295706460174, 0.14766081887024, 0.10917772648781,
                       0.65537964721636, 0.85993553962300, 0.27005692302966,
                       0.60795406602280, 0.20903577336554, 0.83544357176213,
                       0.19625423676839, 0.36846706644329, 0.04316379221146,
                       0.35313285310726, 0.20880256642993, 0.03288760244321,
                       0.92070596356788, 0.28690559951423, 0.13696228057604,
                       0.48304476492659, 0.91718832948373, 0.94326139024843,
                       0.13798726306378, 0.96337958657709, 0.66675447446606,
                       0.13411939261862, 0.87184761463072, 0.54199204818550,
                       0.30024795195683, 0.72329742893188, 0.75463547321909,
                       0.85482963055153, 0.96812548278286, 0.65967740141353,
                       0.86998125082718, 0.12069098956052, 0.45744949075792,
                       0.36156376822509, 0.95550748741274, 0.49835903355519,
                       0.63836537484582, 0.72793338620788, 0.44403610347897,
                       0.59877858363669, 0.46309493603068, 0.77230405826599,
                       0.47454958421185, 0.85312431501073, 0.92795208353574,
                       0.71563279817834, 0.47336296217923, 0.39934504761509,
                       0.65961540124982, 0.73774990203665, 0.81083111997338,
                       0.92882497043693, 0.32548850990765, 0.11517965685519,
                       0.97722904763123, 0.59282530603022, 0.42831996994135,
                       0.68841012715646, 0.15052766014136, 0.94959530872073,
                       0.57024914580762, 0.96544016990197, 0.49673673927798,
                       0.50633670578221, 0.94874338389338, 0.22385892271541,
                       0.51003594583469, 0.68040127258357, 0.94333824812107,
                       0.84206147686310, 0.42631460353950, 0.40584122335102,
                       0.96820385818745, 0.73748609026117, 0.12365350595429,
                       0.23232548638943, 0.07999625031088, 0.47816673892222,
                       0.65902437414411, 0.53492210635974, 0.49813755088929,
                       0.18948020810734, 0.99725697765008, 0.04137789415637,
                       0.08118041648111, 0.15654848530639, 0.75607298554737,
                       0.44952433980860, 0.33198601931402, 0.95974194645751,
                       0.30272675319435, 0.37781994362671, 0.42219031931813,
                       0.80271175314889, 0.87124312050403, 0.98262236521665,
                       0.73916427685395, 0.97254473916944, 0.12600998373744,
                       0.48960493743203, 0.05036706524447, 0.56275579591350});
    c = NDArray(
        {6, 2, 2},
        vector<double>{0.84414557604167, 0.52496605886782, 0.69349586064543,
                       0.60916248958479, 0.36648812132905, 0.73097447093408,
                       0.17426248511952, 0.81203632894508, 0.47357850368745,
                       0.09659577615606, 0.30616774292354, 0.47590672981805,
                       0.97521493941900, 0.39790284693175, 0.60331347804872,
                       0.13797103193230, 0.68078590108712, 0.15907818768005,
                       0.40180970866573, 0.33355848371469, 0.60288792490597,
                       0.44401464722287, 0.47623072885872, 0.27366516198880});
    d = NDArray({2, 6}, vector<double>{0.94035241987803, 0.99520860519858,
                                       0.71529261962372, 0.81035526126688,
                                       0.13413897507259, 0.17844272476337,
                                       0.11725070981814, 0.30963521441833,
                                       0.37790071223911, 0.17159766840745,
                                       0.54086364945327, 0.13049809629650});
    ref = NDArray({6, 4, 6},
                  vector<double>{
                      33.14127563031539, 24.95100261657702, 32.41684958700109,
                      32.86793418365109, 32.25642097316324, 29.98657207626231,
                      28.36923983157972, 30.95562320451736, 33.58588220638867,
                      25.94165922882449, 31.77840568241271, 28.50777762157528,
                      29.30284587119367, 30.77036569344417, 29.32155680021044,
                      21.78870136343131, 34.85393858774528, 25.53617534427495,
                      29.01222130260023, 36.27096488108534, 36.51876052591876,
                      36.18790689918659, 33.82665615744988, 31.91636509614277,
                      19.98525662619734, 14.95548673123868, 19.57818772357345,
                      19.75028705805832, 19.30021397854189, 17.99865391071030,
                      17.19226033886817, 18.68272623772818, 20.21768390710141,
                      15.51584716517796, 19.30398164541183, 17.12609038702960,
                      17.56060556489475, 18.57277036395138, 18.13799539270200,
                      13.27147185062675, 20.98711541525049, 15.63548703240834,
                      17.44411935261834, 21.79823012430453, 22.24648962543316,
                      21.65206175868978, 20.35110696597573, 19.33010234681270,
                      16.84743613082937, 12.65935083333812, 16.47362625844330,
                      16.68625770485964, 16.43841141808879, 15.23259071504961,
                      14.41426633664698, 15.71854373456850, 17.05280497684803,
                      13.17847730718174, 16.18784510159564, 14.43374370777436,
                      14.89852610233045, 15.59155859399031, 14.86049906040635,
                      11.08596198813865, 17.63431126786471, 12.94153181048176,
                      14.70999473748222, 18.46413688103054, 18.55456848343551,
                      18.42828860689479, 17.21096090134521, 16.14262092556879,
                      29.12645530383189, 22.19429562262237, 28.45070778884834,
                      28.73262171454938, 28.37354787063607, 26.06374016994838,
                      25.11806938398364, 27.27309921394956, 29.46324808945717,
                      22.73273613330540, 27.82231624353177, 24.86682618088902,
                      25.68544204049099, 27.30220352229802, 25.69077870471301,
                      19.19444532557674, 30.68274585559179, 22.33118135914876,
                      25.59770261285302, 31.95917735027583, 32.04779009627597,
                      32.03160412053568, 29.78661369927793, 27.89274007372862,
                      21.00821307604391, 15.92001000788186, 20.52608190018303,
                      20.74681489755180, 20.49396076096677, 18.86661226291893,
                      18.06174032039405, 19.63908570247467, 21.24872081758142,
                      16.40802364203478, 20.12072690513364, 17.93777854957004,
                      18.54717340907588, 19.58323958127234, 18.50805037892432,
                      13.83895980168216, 22.04925426549563, 16.10046090953356,
                      18.40612812726145, 23.05195432403355, 23.11674079089504,
                      23.07273116322238, 21.48226898127876, 20.09104840481203,
                      22.58466415504544, 17.07259635164943, 22.08589624505787,
                      22.36672320583541, 21.96000712426450, 20.36440691063181,
                      19.38605581379798, 21.12038153208955, 22.88151446779755,
                      17.65828720667393, 21.62440256986513, 19.40352978083549,
                      19.94459643432412, 21.05510487534900, 20.01148356763591,
                      14.86328380847847, 23.79926380510806, 17.40770821180093,
                      19.80880084145621, 24.72119292509412, 24.89349408414439,
                      24.69080323438901, 23.05599230948456, 21.75363125987571});

    diff =
        (NDArray::einsum("ijkl,xiky,ayp,px->ajl", {a, b, c, d}) - ref).norm();
    EXPECT_LT(diff, 1E-12);

    ref = NDArray({4, 6},
                  vector<double>{
                      33.14127563031539, 14.95548673123867, 16.47362625844330,
                      28.73262171454938, 20.49396076096677, 20.36440691063181,
                      28.36923983157972, 18.68272623772818, 17.05280497684803,
                      22.73273613330540, 20.12072690513364, 19.40352978083549,
                      29.30284587119366, 18.57277036395138, 14.86049906040635,
                      19.19444532557674, 22.04925426549563, 17.40770821180093,
                      29.01222130260022, 21.79823012430453, 18.55456848343551,
                      32.03160412053568, 21.48226898127876, 21.75363125987571});

    diff = (NDArray::einsum("ijkl,xiky,lyp,px->jl", {a, b, c, d}) - ref).norm();
    EXPECT_LT(diff, 1E-12);
}